# AGENTS.md

## Project Overview

- superFetch is a Model Context Protocol (MCP) server that fetches web pages, extracts readable content (Mozilla Readability), and returns AI-friendly Markdown.
- Primary runtime: Node.js (ESM) with TypeScript.
- Runs in two modes:
  - stdio mode for direct MCP integration.
  - HTTP mode (default) using the MCP Streamable HTTP transport.

## Repo Map / Structure

- [src/](src/): TypeScript source.
  - [src/index.ts](src/index.ts): CLI entrypoint; parses `--stdio` and starts stdio or HTTP server.
  - [src/server.ts](src/server.ts): stdio MCP server wiring (register tools + resources).
  - [src/http/](src/http/): HTTP server + session transport, auth, CORS, download routes.
  - [src/tools/](src/tools/): MCP tool implementations (example: [src/tools/handlers/fetch-url.tool.ts](src/tools/handlers/fetch-url.tool.ts)).
  - [src/resources/](src/resources/): MCP resources (example: [src/resources/cached-content.ts](src/resources/cached-content.ts)).
  - [src/services/](src/services/): fetch/extraction pipeline, caching, logging.
  - [src/utils/](src/utils/): shared helpers (notably URL/SSRF validation in [src/utils/url-validator.ts](src/utils/url-validator.ts)).
  - [src/config/](src/config/): environment-variable configuration.
- [tests/](tests/): Node test runner tests. Tests import from `dist/` (built output), not from `src/`.
- `dist/`: build output (generated by `npm run build`). Do not hand-edit.
- [scripts/](scripts/): quality/perf reports and release helper scripts.
- [docs/](docs/): documentation assets (currently includes logo).
- [.github/workflows/](.github/workflows/): CI/release automation.

## Setup & Environment

- Node.js: `>=20.12.0` (see `engines.node` in package.json).
- Install dependencies:
  - Local dev: `npm install`
  - CI/clean install: `npm ci`
- Configuration:
  - Environment variables documented in [CONFIGURATION.md](CONFIGURATION.md) and in the README.

## Development Workflow

- Dev (watch mode): `npm run dev`
- Build: `npm run build`
- Start (production): `npm start`
- Run MCP Inspector (manual): `npm run inspector`

Notes:

- HTTP mode is the default when running the built binary (`npm start` / `node dist/index.js`).
- stdio mode is enabled with `--stdio` (example: `node dist/index.js --stdio`).

## Testing

- All tests: `npm test`
  - This script builds first, then runs Node’s test runner with `--experimental-transform-types`.
- Coverage: `npm run test:coverage`
- Test location: [tests/](tests/)

Important:

- Tests import compiled modules from `dist/`, so running tests without building will fail. Use `npm test` (it builds for you).

## Code Style & Conventions

- Language/module system:
  - TypeScript with `module`/`moduleResolution` set to `NodeNext`.
  - Package is ESM (`"type": "module"`).
  - Local imports use `.js` extensions in source (compiled output target).
- Formatting:
  - Prettier via `npm run format`.
  - Prettier config: [.prettierrc](.prettierrc) (includes import sorting via `@trivago/prettier-plugin-sort-imports`).
- Linting:
  - `npm run lint` (ESLint flat config in [eslint.config.mjs](eslint.config.mjs)).
  - Notable conventions enforced by ESLint:
    - Type-only imports preferred.
    - Explicit function return types (for exported/public-facing functions).
    - Strict TypeScript checks (project-aware lint).
- Type checking:
  - `npm run type-check` (tsc `--noEmit`).

## Build / Release

- Build output directory: `dist/`.
- Build command: `npm run build` (TypeScript compilation using `tsconfig.build.json`).
- Publish gate (local): `npm run prepublishOnly` runs lint, type-check, and build.
- Automation:
  - Tag-based release workflow: [.github/workflows/release.yml](.github/workflows/release.yml)
  - Publish-on-release workflow: [.github/workflows/publish.yml](.github/workflows/publish.yml)
- Helper scripts:
  - [scripts/release.sh](scripts/release.sh)
  - [scripts/release.bat](scripts/release.bat)

## Security & Safety

- This server fetches arbitrary URLs on behalf of an AI assistant.
- Do not weaken SSRF and URL validation behavior without explicit review. Key implementation area: [src/utils/url-validator.ts](src/utils/url-validator.ts).
- Security behavior documented in the README:
  - Blocks private/loopback/link-local/etc IP ranges.
  - Blocks common cloud metadata endpoints and internal suffixes.
  - Validates protocol (`http`/`https`), disallows embedded credentials, limits URL length.
- HTTP mode notes (from docs): authentication is required, and binding/Host/Origin validation are enforced.
- If you touch fetch/network code, ensure failures are safe-by-default (timeouts, size limits, no credential leakage).

## Pull Request / Commit Guidelines

- Before opening a PR, run:
  - `npm run lint`
  - `npm run type-check`
  - `npm test`
- The README includes a basic contributing flow; there is no additional commit convention documented beyond that.

## Troubleshooting

- Tests show an experimental warning:
  - Expected: Node test runner is invoked with `--experimental-transform-types`.
- Windows + npx issues:
  - README suggests using `cmd /c "npx -y @j0hanz/superfetch@latest --stdio"` if needed.
- “Module not found” in tests:
  - Ensure `dist/` exists by running `npm test` or `npm run build`.
