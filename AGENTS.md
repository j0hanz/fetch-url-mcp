# AGENTS.md

## Project Overview

- **superFetch MCP Server** – an intelligent web content fetcher that converts HTML to clean, AI-readable Markdown
- **Package**: `@j0hanz/superfetch` (npm), MCP registry ID: `io.github.j0hanz/superfetch`
- **Tech stack**: Node.js ≥20.18.1, TypeScript 5.9, Express 5, Zod 4, MCP SDK
- **Core deps**: `@modelcontextprotocol/sdk`, `@mozilla/readability`, `linkedom`, `node-html-markdown`, `undici`

## Repo Map / Structure

- `src/` – TypeScript source (entry: `src/index.ts`, server: `src/server.ts`)
  - `config/` – environment parsing, constants, types
  - `errors/` – custom error classes
  - `http/` – Express routes, auth, CORS, session management
  - `resources/` – MCP resource handling (cached content)
  - `services/` – caching, fetching, logging, telemetry, worker pool
  - `tools/` – MCP tool handlers and schemas (`fetch-url`)
  - `transformers/` – HTML-to-Markdown conversion
  - `utils/` – URL validation, crypto, guards, cancellation
  - `workers/` – transform worker pool
- `dist/` – compiled output (generated by `npm run build`)
- `tests/` – Node.js test runner tests (`*.test.ts`, one `*.test.js`)
- `docs/` – logo only
- `.github/workflows/` – CI: `release.yml` (tag-triggered), `publish.yml` (release-triggered)

## Setup & Environment

- **Install dependencies**: `npm install` (or `npm ci` for CI)
- **Required Node version**: `>=20.18.1` (see `engines` in `package.json`)
- **Env config**: See `CONFIGURATION.md` for all environment variables
- **No required services** – runs standalone; HTTP mode requires auth tokens or OAuth

## Development Workflow

- **Dev mode (hot reload)**: `npm run dev`
- **Build**: `npm run build`
- **Production start**: `npm start` (runs `node dist/index.js`)
- **MCP Inspector**: `npm run inspector`

## Testing

- **All tests**: `npm test`
- **Coverage**: `npm run test:coverage`
- **Test location**: `tests/*.test.ts` (and one `.test.js`)
- **Runner**: Node.js built-in test runner with `--experimental-transform-types`
- **Note**: Tests build `dist/` first (`npm run build --silent`)

## Code Style & Conventions

- **Language**: TypeScript 5.9 (strict mode, `noUncheckedIndexedAccess`, `exactOptionalPropertyTypes`)
- **Lint**: `npm run lint` (ESLint 9 with `typescript-eslint`, `sonarjs`, `de-morgan`, `depend`, `unused-imports`)
- **Lint fix**: `npm run lint:fix`
- **Format**: `npm run format` (Prettier)
- **Type check**: `npm run type-check`
- **Dead code**: `npm run knip` / `npm run knip:fix`

### Naming Conventions (ESLint-enforced)

- **Variables/functions**: `camelCase` (leading underscore allowed)
- **Constants**: `camelCase`, `UPPER_CASE`, or `PascalCase`
- **Types/interfaces**: `PascalCase`
- **Enum members**: `PascalCase` or `UPPER_CASE`
- **Properties**: any format (external APIs)
- **Imports**: `camelCase` or `PascalCase`

### Import Order (Prettier-enforced)

1. Node built-ins (`node:*`)
2. Third-party modules
3. `@modelcontextprotocol/*`, `@mozilla/*`
4. Internal: `config/` → `errors/` → `services/` → `middleware/` → `utils/` → `transformers/` → `tools/` → `prompts/` → `resources/`
5. Relative (`./`, `../`)

### Key Rules

- Use `type` imports for type-only imports
- Explicit return types on functions
- No `any` (error)
- Prefer `??` over `||`, prefer optional chaining
- Prefer arrow functions, destructuring, template literals
- No unused imports/vars (auto-fixed)

## Build / Release

- **Build output**: `dist/` (ES modules, declarations)
- **Release process**:
  1. Bump version in `package.json`
  2. Push tag `v*.*.*` → triggers `release.yml` (lint, type-check, build, npm publish)
  3. GitHub Release triggers `publish.yml` (alternative publish path)
- **Prepublish checks**: `npm run lint && npm run type-check && npm run build`

## Security & Safety

- **SSRF protection**: Blocks private IPs, cloud metadata endpoints, `.local`/`.internal` domains
- **URL validation**: Only `http`/`https`, no embedded credentials, max 2048 chars
- **Rate limiting**: 100 req/min per IP (HTTP mode)
- **Auth required**: HTTP mode requires static tokens (`API_KEY`/`ACCESS_TOKENS`) or OAuth
- **No secrets in repo**: All credentials via environment variables

## Pull Request / Commit Guidelines

- **Branch naming**: `feature/<name>`, `fix/<name>`, etc.
- **Required checks before PR**:
  - `npm run lint`
  - `npm run type-check`
  - `npm test`
- **CI validates**: lint → type-check → build (see `.github/workflows/`)
- **Commit style**: Conventional-ish (`Add amazing feature`, `Fix bug in X`)

## Troubleshooting

| Issue                   | Solution                                                  |
| ----------------------- | --------------------------------------------------------- |
| Tests fail on import    | Ensure `npm run build` succeeded; tests require `dist/`   |
| Type errors             | Run `npm run type-check`; strict mode catches many issues |
| Lint errors             | Run `npm run lint:fix` for auto-fixable issues            |
| HTTP mode won't start   | Set `API_KEY` or `ACCESS_TOKENS` for auth                 |
| Binding to non-loopback | Set `ALLOW_REMOTE=true` and configure OAuth               |

## Agent Operating Rules

1. **Search before edit** – Use grep/find to understand existing patterns before modifying code
2. **Read docs first** – Check `README.md`, `CONFIGURATION.md` before changing behavior
3. **Run checks** – Always run `npm run lint && npm run type-check` after edits
4. **No destructive commands** – Avoid `rm -rf`, force pushes, or irreversible operations
5. **Respect import order** – Prettier will auto-sort; don't manually reorder imports
6. **Use type imports** – `import { type Foo }` for type-only imports
7. **Test after changes** – Run `npm test` to verify nothing broke
